{"title":"Taxa Richness as a funciton of latitude","markdown":{"yaml":{"title":"Taxa Richness as a funciton of latitude"},"headingText":"we need to trim out the hs casts","containsRefs":false,"markdown":"\n\n```{r warning=FALSE}\nrm(list = ls())\nlibrary(EcotaxaTools)\nlibrary(ggplot2)\nlibrary(tibble)\n\nuvp_dat <- ecopart_import(\"~/BV_transect_export\") #load in initial ecopart object\n\n# One way to do that would be to hard-code indices for those but that's not reliable\n#So I'm using regex\n\n#get index of hs data for both par and zoo files\nhs_index_par <- grep(\"hs\",names(uvp_dat$par_files))\nhs_index_zoo <- grep('hs', names(uvp_dat$zoo_files))\n\nuvp_dat$par_files <- uvp_dat$par_files[-hs_index_par]\nuvp_dat$zoo_files <- uvp_dat$zoo_files[-hs_index_zoo]\n```\n\nIn this analysis we are going to look at the richness of different taxa along the latitudinal gradient. We'll use simpson's diversity index. There's a wide range of how this is calculated but I like to do the probability of two randomly selected individuals being the same group. One important caveat for our approach here is that not all taxa are identified to the same specificity. Some are genera, some are family, some are even more broad. This can greatly influence the reliability of this index. This is particularly important to think about with Rhizaria. Those we can identify with much more specificity than other groups. For that reason, if we just did best possible taxonomic category, our biodiversity index would just be a function of overall rhizaria abundance. So I'm going to split up Rhizaria biodiversity and other zooplankton diversity. Notably, I'm excluding trichodesmium which is a phytoplankton.\n\n### 1 - Getting our data set up\n\nFirst, we need to set up our data frames. We only need the identification data here, not the volumes. I'm going to make two lists, one with just the Rhizaria, another with just the other zooplankton\n\n```{r}\nRhiz_names <- c('Rhizaria', 'living', 'not-living', 'Collodaria') #these are going to be used as an index to keep rhizaria\nother_names <- c('living', 'Actinopterygii','Alciopidae','Amphipoda','Annelida','not-living','Copepoda','Chaetognatha','Cnidaria','Crustacea','Ctenophora','Decapoda','Echinodermata','Eucalanidae','Hydrozoa','Ostracoda','Polychaeta','Pteropoda','Salpidae','Siphonophorae','Tomopteridae')\n\nrhiz_dat <- add_zoo(uvp_dat, names_to, 'Rhiz_or_not', Rhiz_names, suppress_print = T)\nother_zoop <- add_zoo(uvp_dat, names_to, 'Zoop', other_names, suppress_print = T)\n\ntrim_to <- function(df, match_col, drop_names) {\n  \n  rdf <- df[which(!(df[[match_col]] %in% drop_names)),]\n  return(rdf)\n  \n}\n\nrhiz_only <- lapply(rhiz_dat$zoo_files, trim_to, 'Rhiz_or_not',c('living','not-living'))\nother_only <- lapply(other_zoop$zoo_files, trim_to, 'Zoop',c('living','not-living'))\n```\n\n### 2 - Calculating diversity index.\n\nNow, I have two lists of tibbles: one with just the rhizaria and one with all other zooplankton. We'll want to loop through these and assign them diversity values.\n\n#### Let's define a function for diversity:\n\n```{r}\n#' Get Simpson's Diversity Index\n#' \n#' @param vect a character vector of taxa names\nsimpsons_d <- function(vect) {\n  prob <- table(vect) / length(vect)\n  return(sum(prob^2))\n}\n```\n\nNow we can use that function for calculating the diversity with each cast. But first, we'll want to separate out the casts into euphotic, upper meso, lower meso, and bathypelagic\n\n```{r}\ndb <- c(0,200,500,1200,4000)\nrhiz_bins <- lapply(rhiz_only, bin_taxa,db)\nzoo_bins <- lapply(other_only, bin_taxa,db)\n\n#a quicker way to get it with existing functions\nrhiz_bins <- lapply(rhiz_bins, function(df) {split(df, f = df[['db']])})\nzoo_bins <- lapply(zoo_bins, function(df) {split(df, f = df[['db']])})\n\nsim_d <- function(df) {\n  if(nrow(df) == 0) {\n    return(NA)\n  }\n  prob <- df$x/sum(df$x)\n  return(sum(prob^2))\n}\n\nrhiz_div <- vector('list', length(rhiz_bins))\nzoo_div <- vector('list', length(zoo_bins))\nnames(rhiz_div) <- names(rhiz_bins)\nnames(zoo_div) <- names(zoo_bins)\nfor(i in 1:length(rhiz_div)) {\n  rhiz_div[[i]] <- lapply(rhiz_bins[[i]], sim_d)\n  zoo_div[[i]] <- lapply(zoo_bins[[i]], sim_d)\n  \n  rhiz_div[[i]] <- data.frame(db = names(rhiz_div[[i]]),\n                              sim_d = unlist(rhiz_div[[i]]),\n                              profile_id = names(rhiz_div[i]))\n  zoo_div[[i]] <- data.frame(db = names(zoo_div[[i]]),\n                             sim_d = unlist(zoo_div[[i]]),\n                             profile_id = names(zoo_div[i]))\n}\nrhiz_div <- do.call(rbind, rhiz_div)\nzoo_div <- do.call(rbind, zoo_div)\nrow.names(rhiz_div) <- NULL\nrow.names(zoo_div) <- NULL\n\n#trim out the deepest observations\nrhiz_div <- rhiz_div[rhiz_div$db %in% levels(cut(db,db)),]\nzoo_div <- zoo_div[zoo_div$db %in% levels(cut(db,db)),]\n```\n\nAnd we'll have to merge those with latitude data\n\n```{r}\nrhiz_div <- merge(rhiz_div, \n                  data.frame(profile_id = uvp_dat$meta$profileid,\n                             lat = uvp_dat$meta$latitude))\nzoo_div <- merge(zoo_div, \n                  data.frame(profile_id = uvp_dat$meta$profileid,\n                             lat = uvp_dat$meta$latitude))\n\nggplot(rhiz_div, aes(x = lat, y = sim_d, col = db))+\n  geom_point(alpha = .5, size = 1)+\n  geom_line(stat = 'smooth', method = 'gam',\n            alpha = .6, span = 5, size = 1)+\n  coord_flip()+\n  labs(x = 'Latitude', y = 'Simpsons D', subtitle = 'Rhizaria')+\n  theme_bw()\n\nggplot(zoo_div, aes(x = lat, y = sim_d, col = db))+\n  geom_point(alpha = .5, size = 1)+\n  geom_line(stat = 'smooth', method = 'gam',\n            alpha = .6, span = 5, size = 1)+\n  coord_flip()+\n  labs(x = 'Latitude', y = 'Simpsons D', subtitle = 'Other Zoops')+\n  theme_bw()\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"self-contained-math":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"output-file":"bv57_exploratory_taxa-diversity.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"editor":"visual","theme":"cosmo","title":"Taxa Richness as a funciton of latitude"},"extensions":{"book":{"multiFile":true}}}}}